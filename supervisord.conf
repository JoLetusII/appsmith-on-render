[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor

[inet_http_server]
port=127.0.0.1:9001

[supervisorctl]
serverurl=http://127.0.0.1:9001

; ---------- NGINX ----------
[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
autorestart=true
priority=10
stdout_logfile=/var/log/supervisor/nginx.stdout.log
stderr_logfile=/var/log/supervisor/nginx.stderr.log
startretries=999

; ---------- APPSMITH SERVER (Java) ----------
; Try official script if it exists, else fall back to known JAR paths.
[program:appsmith-server]
command=/bin/bash -lc '
  set -e;
  if [ -x /opt/appsmith/scripts/start-server.sh ]; then
    exec /opt/appsmith/scripts/start-server.sh;
  elif [ -f /opt/appsmith/backend/server.jar ]; then
    exec java -XX:+UseZGC -Dserver.port=8080 -jar /opt/appsmith/backend/server.jar;
  elif [ -f /opt/appsmith/server.jar ]; then
    exec java -XX:+UseZGC -Dserver.port=8080 -jar /opt/appsmith/server.jar;
  else
    echo "Cannot locate server.jar or start-server.sh. Layout changed."; ls -R /opt/appsmith; exit 1;
  fi
'
directory=/opt/appsmith
environment=JAVA_TOOL_OPTIONS="-XX:MaxRAMPercentage=75"
autorestart=true
priority=20
stdout_logfile=/var/log/supervisor/server.stdout.log
stderr_logfile=/var/log/supervisor/server.stderr.log
startretries=999

; ---------- APPSMITH RTS (Node) ----------
; Try official script first, then common dist paths.
[program:appsmith-rts]
command=/bin/bash -lc '
  set -e;
  if [ -x /opt/appsmith/scripts/start-rts.sh ]; then
    exec /opt/appsmith/scripts/start-rts.sh;
  elif [ -f /opt/appsmith/rts/server/dist/server.js ]; then
    exec node /opt/appsmith/rts/server/dist/server.js;
  elif [ -f /opt/appsmith/rts/dist/server.js ]; then
    exec node /opt/appsmith/rts/dist/server.js;
  else
    echo "Cannot locate RTS entrypoint. Layout changed."; ls -R /opt/appsmith/rts || true; exit 1;
  fi
'
directory=/opt/appsmith
autorestart=true
priority=30
stdout_logfile=/var/log/supervisor/rts.stdout.log
stderr_logfile=/var/log/supervisor/rts.stderr.log
startretries=999




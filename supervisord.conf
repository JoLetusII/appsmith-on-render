[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor

; ---- Supervisor Web UI over UNIX socket (allow nginx to reach it) ----
[unix_http_server]
file=/tmp/supervisor.sock
chmod=0770
chown=www-data:www-data
; Optional auth:
;username=admin
;password=change-me

[supervisorctl]
serverurl=unix:///tmp/supervisor.sock

; ---------- REDIS (needed by RTS) ----------
; Prefer Appsmith's script if present; otherwise run redis-server directly.
[program:redis]
command=/bin/sh -lc 'if [ -x /opt/appsmith/scripts/start-redis.sh ]; then exec /opt/appsmith/scripts/start-redis.sh; else exec redis-server --port 6379 --save "" --appendonly no; fi'
autorestart=true
priority=5
stdout_logfile=/var/log/supervisor/redis.stdout.log
stderr_logfile=/var/log/supervisor/redis.stderr.log
startretries=999
startsecs=2

; ---------- MONGODB (Appsmith primary DB when using local URI) ----------
; Prefer Appsmith's script if present; fallback to mongod with sensible flags.
[program:mongodb]
command=/bin/sh -lc 'if [ -x /opt/appsmith/scripts/start-mongodb.sh ]; then exec /opt/appsmith/scripts/start-mongodb.sh; else exec mongod --bind_ip 127.0.0.1 --dbpath /appsmith-stacks/data/mongodb --replSet rs0 --keyFile /appsmith-stacks/data/mongodb/key --wiredTigerCacheSizeGB 1; fi'
autorestart=true
priority=8
stdout_logfile=/var/log/supervisor/mongo.stdout.log
stderr_logfile=/var/log/supervisor/mongo.stderr.log
startretries=999
startsecs=5

; ---------- NGINX ----------
[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
autorestart=true
priority=10
stdout_logfile=/var/log/supervisor/nginx.stdout.log
stderr_logfile=/var/log/supervisor/nginx.stderr.log
startretries=999
startsecs=2

; ---------- APPSMITH SERVER (Java) ----------
[program:appsmith-server]
command=/usr/local/bin/start-appsmith-server.sh
directory=/opt/appsmith
environment=JAVA_TOOL_OPTIONS="-XX:+UseZGC -XX:MaxRAMPercentage=50 -XX:InitialRAMPercentage=15"
autorestart=true
priority=20
stdout_logfile=/var/log/supervisor/server.stdout.log
stderr_logfile=/var/log/supervisor/server.stderr.log
startretries=999
startsecs=3

; ---------- APPSMITH RTS (Node) ----------
[program:appsmith-rts]
command=/usr/local/bin/start-appsmith-rts.sh
directory=/opt/appsmith
environment=NODE_OPTIONS="--max-old-space-size=256"
autorestart=true
priority=30
stdout_logfile=/var/log/supervisor/rts.stdout.log
stderr_logfile=/var/log/supervisor/rts.stderr.log
startretries=999
startsecs=3







